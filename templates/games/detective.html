{% extends "base.html" %}

{% block title %}AIæ¨ç†ä¾¦æ¢æ¸¸æˆ - æ™ºèƒ½AIå·¥å…·å¹³å°{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-800 via-blue-900 to-gray-900">
    <!-- æ¸¸æˆå¤´éƒ¨ -->
    <div class="bg-gradient-to-r from-slate-700 to-blue-800 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-blue-100 hover:text-white mr-6">
                        â† è¿”å›ä¸»é¡µ
                    </a>
                    <h1 class="text-xl font-bold text-blue-100">ğŸ” AIæ¨ç†ä¾¦æ¢æ¸¸æˆ</h1>
                </div>
                <div class="text-blue-200 text-sm">
                    æ¡ˆä»¶ID: {{ session_id[:8] }}...
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- ä¸»è¦æ¸¸æˆåŒºåŸŸ -->
            <div class="lg:col-span-3">
                <!-- æ¡ˆä»¶æ¶ˆæ¯åŒºåŸŸ -->
                <div id="messageArea" class="bg-black bg-opacity-50 rounded-lg p-6 h-96 overflow-y-auto mb-6 backdrop-blur-sm border border-blue-600">
                    {% if recent_messages %}
                        {% for message in recent_messages %}
                        <div class="message mb-4 p-3 rounded-lg {% if message.speaker_type == 'user' %}bg-blue-800 bg-opacity-60 ml-8{% elif message.speaker_type == 'system' %}bg-gray-800 bg-opacity-60{% elif message.speaker_type == 'npc' %}bg-purple-800 bg-opacity-60 mr-8{% else %}bg-slate-800 bg-opacity-60{% endif %}">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-blue-100">
                                    {% if message.speaker_type == 'user' %}ğŸ•µï¸{% elif message.speaker_type == 'system' %}ğŸ”{% elif message.speaker_type == 'npc' %}ğŸ‘¤{% else %}ğŸ¤–{% endif %}
                                    {{ message.speaker_name }}
                                </span>
                                <span class="text-blue-300 text-xs ml-2">{{ message.timestamp }}</span>
                            </div>
                            <div class="text-blue-100 whitespace-pre-wrap">{{ message.content }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-blue-300 mt-20">
                            <div class="text-6xl mb-4">ğŸ”</div>
                            <p>æ¡ˆä»¶åŠ è½½ä¸­...</p>
                        </div>
                    {% endif %}
                </div>

                <!-- æ“ä½œé¢æ¿ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- å«Œç–‘äººå®¡è®¯ -->
                    <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                        <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸ‘¥ å«Œç–‘äººå®¡è®¯</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-200 mb-2">é€‰æ‹©å«Œç–‘äººï¼š</label>
                                <select id="suspectSelect" class="w-full bg-gray-800 text-blue-100 rounded px-3 py-2 border border-blue-600">
                                    <option value="">é€‰æ‹©å«Œç–‘äºº...</option>
                                    <option value="æå¤«äºº">æå¤«äºº</option>
                                    <option value="å¼ åŠ©ç†">å¼ åŠ©ç†</option>
                                    <option value="ç‹å¾‹å¸ˆ">ç‹å¾‹å¸ˆ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-blue-200 mb-2">æ‚¨çš„é—®é¢˜ï¼š</label>
                                <textarea id="questionText" class="w-full bg-gray-800 text-blue-100 rounded px-3 py-2 border border-blue-600" rows="3" placeholder="è¾“å…¥æ‚¨è¦é—®çš„é—®é¢˜..."></textarea>
                            </div>
                            <button onclick="interrogateSuspect()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-all">
                                ğŸ” å¼€å§‹å®¡è®¯
                            </button>
                        </div>
                    </div>

                    <!-- è¯æ®åˆ†æ -->
                    <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                        <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸ”¬ è¯æ®åˆ†æ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-200 mb-2">é€‰æ‹©è¯æ®ï¼š</label>
                                <select id="evidenceSelect" class="w-full bg-gray-800 text-blue-100 rounded px-3 py-2 border border-blue-600">
                                    <option value="">é€‰æ‹©è¯æ®...</option>
                                    <option value="èŒ¶æ¯">èŒ¶æ¯</option>
                                    <option value="ç®¡å®¶è¯è¨€">ç®¡å®¶è¯è¨€</option>
                                    <option value="ä¿é™©å•">ä¿é™©å•</option>
                                    <option value="æ‰‹æœºè®°å½•">æ‰‹æœºè®°å½•</option>
                                    <option value="è´¢åŠ¡æŠ¥è¡¨">è´¢åŠ¡æŠ¥è¡¨</option>
                                </select>
                            </div>
                            <button onclick="analyzeEvidence()" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-all">
                                ğŸ§ª åˆ†æè¯æ®
                            </button>
                            <button onclick="showAllEvidence()" class="w-full bg-gradient-to-r from-gray-600 to-slate-600 hover:from-gray-700 hover:to-slate-700 text-white px-4 py-2 rounded-lg text-sm transition-all">
                                ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰è¯æ®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ¨ç†ç»“è®º -->
                <div class="mt-6 bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                    <h3 class="text-lg font-bold text-blue-100 mb-4">âš–ï¸ æäº¤æ¨ç†ç»“è®º</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-200 mb-2">æŒ‡æ§å«Œç–‘äººï¼š</label>
                            <select id="accusedSelect" class="w-full bg-gray-800 text-blue-100 rounded px-3 py-2 border border-blue-600">
                                <option value="">é€‰æ‹©çœŸå‡¶...</option>
                                <option value="æå¤«äºº">æå¤«äºº</option>
                                <option value="å¼ åŠ©ç†">å¼ åŠ©ç†</option>
                                <option value="ç‹å¾‹å¸ˆ">ç‹å¾‹å¸ˆ</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <button onclick="submitConclusion()" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white px-4 py-3 rounded-lg font-bold transition-all">
                                âš–ï¸ æäº¤ç»“è®º
                            </button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-blue-200 mb-2">æ¨ç†è¿‡ç¨‹ï¼š</label>
                        <textarea id="reasoningText" class="w-full bg-gray-800 text-blue-100 rounded px-3 py-2 border border-blue-600" rows="4" placeholder="è¯¦ç»†è¯´æ˜æ‚¨çš„æ¨ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å…³é”®è¯æ®å’Œé€»è¾‘æ¨å¯¼..."></textarea>
                    </div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="space-y-6">
                <!-- è°ƒæŸ¥è¿›åº¦ -->
                <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                    <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸ“Š è°ƒæŸ¥è¿›åº¦</h3>
                    <div class="space-y-3 text-blue-200 text-sm">
                        <div class="flex justify-between">
                            <span>å®¡è®¯æ¬¡æ•°ï¼š</span>
                            <span id="interrogationCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å‘ç°çº¿ç´¢ï¼š</span>
                            <span id="clueCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ¡ˆä»¶çŠ¶æ€ï¼š</span>
                            <span id="caseStatus">è°ƒæŸ¥ä¸­</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-blue-700">
                        <div class="text-xs text-blue-300 mb-2">è°ƒæŸ¥è¿›åº¦</div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- å«Œç–‘äººåˆ—è¡¨ -->
                <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                    <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸ‘¥ å«Œç–‘äººæ¡£æ¡ˆ</h3>
                    <div class="space-y-3">
                        <div class="p-3 bg-gray-800 bg-opacity-60 rounded border border-blue-700">
                            <div class="font-medium text-blue-100">æå¤«äºº (45å²)</div>
                            <div class="text-xs text-blue-300">å®¶åº­ä¸»å¦‡ | å—å®³è€…å¦»å­</div>
                            <div class="text-xs text-blue-400 mt-1">åŠ¨æœºï¼šå·¨é¢ä¿é™©é‡‘</div>
                        </div>
                        <div class="p-3 bg-gray-800 bg-opacity-60 rounded border border-blue-700">
                            <div class="font-medium text-blue-100">å¼ åŠ©ç† (28å²)</div>
                            <div class="text-xs text-blue-300">ç§äººåŠ©ç† | å·¥ä½œä¼™ä¼´</div>
                            <div class="text-xs text-blue-400 mt-1">åŠ¨æœºï¼šå†…å¹•äº¤æ˜“è¢«å‘ç°</div>
                        </div>
                        <div class="p-3 bg-gray-800 bg-opacity-60 rounded border border-blue-700">
                            <div class="font-medium text-blue-100">ç‹å¾‹å¸ˆ (55å²)</div>
                            <div class="text-xs text-blue-300">å¾‹å¸ˆ | æ³•å¾‹é¡¾é—®</div>
                            <div class="text-xs text-blue-400 mt-1">åŠ¨æœºï¼šé—å˜±ä¿®æ”¹çº çº·</div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                    <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    <div class="space-y-2">
                        <button onclick="refreshMessages()" class="w-full bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded text-sm transition-all">
                            ğŸ”„ åˆ·æ–°æ¡ˆæƒ…
                        </button>
                        <button onclick="showCaseFile()" class="w-full bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded text-sm transition-all">
                            ğŸ“ æŸ¥çœ‹æ¡ˆä»¶æ¡£æ¡ˆ
                        </button>
                        <button onclick="restartCase()" class="w-full bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded text-sm transition-all">
                            ğŸ”„ é‡æ–°å¼€å§‹
                        </button>
                    </div>
                </div>

                <!-- è°ƒæŸ¥æç¤º -->
                <div class="bg-black bg-opacity-50 rounded-lg p-6 backdrop-blur-sm border border-blue-600">
                    <h3 class="text-lg font-bold text-blue-100 mb-4">ğŸ’¡ è°ƒæŸ¥æç¤º</h3>
                    <div class="text-blue-200 text-sm space-y-2">
                        <p>â€¢ è¯¢é—®æ¯ä¸ªå«Œç–‘äººçš„ä¸åœ¨åœºè¯æ˜</p>
                        <p>â€¢ å¯»æ‰¾åŠ¨æœºå’Œæœºä¼šçš„è¯æ®</p>
                        <p>â€¢ æ³¨æ„å‰åçŸ›ç›¾çš„ä¾›è¯</p>
                        <p>â€¢ åˆ†æç‰©ç†è¯æ®çš„é‡è¦æ€§</p>
                        <p>â€¢ æ¨ç†è¦æœ‰é€»è¾‘å’Œè¯æ®æ”¯æ’‘</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»“æœæ¨¡æ€æ¡† -->
<div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 border border-blue-600">
        <h3 id="resultTitle" class="text-lg font-bold text-blue-100 mb-4"></h3>
        <div id="resultContent" class="text-blue-200 mb-4"></div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeResultModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<script>
let sessionId = '{{ session_id }}';
let interrogationCount = 0;
let clueCount = 0;

// å®¡è®¯å«Œç–‘äºº
function interrogateSuspect() {
    const suspect = document.getElementById('suspectSelect').value;
    const question = document.getElementById('questionText').value;
    
    if (!suspect || !question.trim()) {
        alert('è¯·é€‰æ‹©å«Œç–‘äººå¹¶è¾“å…¥é—®é¢˜');
        return;
    }
    
    fetch('/api/game/detective/interrogate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: sessionId,
            suspect_name: suspect,
            question: question
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('questionText').value = '';
            interrogationCount = data.interrogation_count || (interrogationCount + 1);
            updateProgress();
            refreshMessages();
        } else {
            alert('å®¡è®¯å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// åˆ†æè¯æ®
function analyzeEvidence() {
    const evidence = document.getElementById('evidenceSelect').value;
    
    if (!evidence) {
        alert('è¯·é€‰æ‹©è¦åˆ†æçš„è¯æ®');
        return;
    }
    
    fetch('/api/game/detective/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: sessionId,
            evidence_name: evidence
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            clueCount = data.discovered_clues || (clueCount + 1);
            updateProgress();
            refreshMessages();
        } else {
            alert('è¯æ®åˆ†æå¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// æäº¤æ¨ç†ç»“è®º
function submitConclusion() {
    const accused = document.getElementById('accusedSelect').value;
    const reasoning = document.getElementById('reasoningText').value;
    
    if (!accused || !reasoning.trim()) {
        alert('è¯·é€‰æ‹©å«Œç–‘äººå¹¶å¡«å†™æ¨ç†è¿‡ç¨‹');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦æäº¤æœ€ç»ˆç»“è®ºå—ï¼Ÿæäº¤åæ¡ˆä»¶å°†ç»“æ¡ˆã€‚')) {
        return;
    }
    
    fetch('/api/game/detective/conclude', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: sessionId,
            suspect: accused,
            reasoning: reasoning
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(data);
            document.getElementById('caseStatus').textContent = 'å·²ç»“æ¡ˆ';
        } else {
            alert('æäº¤å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// æ˜¾ç¤ºç»“æœ
function showResult(data) {
    const title = data.correct ? 'ğŸ‰ ç ´æ¡ˆæˆåŠŸï¼' : 'âŒ æ¨ç†é”™è¯¯';
    const content = `
        <div class="space-y-4">
            <div class="p-4 rounded ${data.correct ? 'bg-green-800' : 'bg-red-800'} bg-opacity-60">
                <p><strong>æ‚¨çš„æŒ‡æ§ï¼š</strong>${data.accused}</p>
                <p><strong>çœŸæ­£å‡¶æ‰‹ï¼š</strong>${data.actual_killer}</p>
                <p><strong>å¾—åˆ†ï¼š</strong>${data.score} åˆ†</p>
            </div>
            <div class="text-sm">
                <h4 class="font-bold mb-2">ä¸“ä¸šè¯„ä»·ï¼š</h4>
                <div class="whitespace-pre-wrap">${data.evaluation}</div>
            </div>
        </div>
    `;
    
    document.getElementById('resultTitle').textContent = title;
    document.getElementById('resultContent').innerHTML = content;
    document.getElementById('resultModal').classList.remove('hidden');
}

// å…³é—­ç»“æœæ¨¡æ€æ¡†
function closeResultModal() {
    document.getElementById('resultModal').classList.add('hidden');
    refreshMessages();
}

// æ›´æ–°è¿›åº¦
function updateProgress() {
    document.getElementById('interrogationCount').textContent = interrogationCount;
    document.getElementById('clueCount').textContent = clueCount;
    
    // è®¡ç®—è¿›åº¦ï¼ˆæœ€å¤š10æ¬¡å®¡è®¯ + 5ä¸ªçº¿ç´¢ï¼‰
    const maxProgress = 15;
    const currentProgress = Math.min(interrogationCount + clueCount, maxProgress);
    const progressPercent = (currentProgress / maxProgress) * 100;
    
    document.getElementById('progressBar').style.width = progressPercent + '%';
}

// æ˜¾ç¤ºæ‰€æœ‰è¯æ®
function showAllEvidence() {
    fetch(`/api/game/detective/evidence?session_id=${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEvidenceList(data.evidence_list);
            } else {
                alert('è·å–è¯æ®åˆ—è¡¨å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            console.error('è·å–è¯æ®åˆ—è¡¨é”™è¯¯:', error);
            alert('è·å–è¯æ®åˆ—è¡¨å¤±è´¥');
        });
}

// æ˜¾ç¤ºè¯æ®åˆ—è¡¨æ¨¡æ€æ¡†
function displayEvidenceList(evidenceList) {
    let evidenceHtml = '<div class="space-y-4">';
    
    if (evidenceList && evidenceList.length > 0) {
        evidenceList.forEach((evidence, index) => {
            const statusIcon = evidence.discovered ? 'ğŸ”' : 'â“';
            const statusText = evidence.discovered ? 'å·²å‘ç°' : 'æœªå‘ç°';
            const analysisStatus = evidence.analyzed ? 'å·²åˆ†æ' : 'å¾…åˆ†æ';
            
            evidenceHtml += `
                <div class="bg-gray-800 p-4 rounded border ${evidence.discovered ? 'border-blue-500' : 'border-gray-600'}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-blue-300 font-semibold">${statusIcon} ${evidence.name}</h4>
                        <span class="text-xs px-2 py-1 rounded ${evidence.discovered ? 'bg-blue-600' : 'bg-gray-600'}">${statusText}</span>
                    </div>
                    <p class="text-gray-300 text-sm mb-2">ç±»å‹: ${evidence.type}</p>
                    <p class="text-gray-400 text-sm mb-3">${evidence.description}</p>
                    ${evidence.discovered ? `
                        <div class="flex space-x-2">
                            <button onclick="analyzeEvidence('${evidence.name}')" 
                                    class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                                ${analysisStatus}
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    } else {
        evidenceHtml += '<p class="text-gray-400">æš‚æ— è¯æ®ä¿¡æ¯</p>';
    }
    
    evidenceHtml += '</div>';
    
    // æ˜¾ç¤ºåœ¨ç»“æœæ¨¡æ€æ¡†ä¸­
    document.getElementById('resultTitle').textContent = 'ğŸ“‹ è¯æ®åˆ—è¡¨';
    document.getElementById('resultContent').innerHTML = evidenceHtml;
    document.getElementById('resultModal').classList.remove('hidden');
}

// æ˜¾ç¤ºæ¡ˆä»¶æ¡£æ¡ˆ
function showCaseFile() {
    alert('æ¡ˆä»¶æ¡£æ¡ˆåŠŸèƒ½å¼€å‘ä¸­...');
}

// åˆ·æ–°æ¶ˆæ¯
function refreshMessages() {
    location.reload();
}

// é‡æ–°å¼€å§‹æ¡ˆä»¶
function restartCase() {
    if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ–°çš„æ¡ˆä»¶å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
        window.location.href = '/game/detective';
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
    const messageArea = document.getElementById('messageArea');
    if (messageArea) {
        messageArea.scrollTop = messageArea.scrollHeight;
    }
    
    // åˆå§‹åŒ–è¿›åº¦
    updateProgress();
});
</script>
{% endblock %}