{% extends 'base.html' %}
{% block title %}AIæ¨ç†ä¾¦æ¢æ¸¸æˆV2{% endblock %}
{% block extra_css %}
<style>
.detective-container { min-height: 90vh; display: flex; flex-direction: column; background: linear-gradient(135deg, #e0e7ff 0%, #f0abfc 100%); }
.detective-header { padding: 32px 0 16px 0; text-align: center; }
.detective-header h2 { font-size: 2.2rem; font-weight: 700; color: #4f46e5; }
.detective-main { flex: 1; display: flex; gap: 32px; max-width: 1200px; margin: 0 auto; }
.detective-info { width: 340px; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #c7d2fe33; padding: 24px; margin-top: 12px; }
.detective-messages { flex: 1; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #c7d2fe33; padding: 24px; margin-top: 12px; display: flex; flex-direction: column; }
.detective-msg-list { flex: 1; overflow-y: auto; margin-bottom: 16px; }
.detective-msg { margin-bottom: 18px; }
.detective-msg .role { font-weight: 600; color: #6366f1; margin-right: 8px; }
.detective-msg .content { display: inline; }
.detective-actions { display: flex; gap: 12px; margin-top: 8px; }
.detective-actions input, .detective-actions select { border: 1px solid #c7d2fe; border-radius: 8px; padding: 6px 12px; }
.detective-actions button { background: linear-gradient(90deg, #6366f1, #a21caf); color: #fff; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: 0.2s; }
.detective-actions button:hover { background: linear-gradient(90deg, #a21caf, #6366f1); }
.detective-notebook { margin-top: 24px; background: #f3f4f6; border-radius: 12px; padding: 16px; font-size: 14px; }
</style>
{% endblock %}
{% block content %}
<div class="detective-container">
  <div class="detective-header">
    <h2>ğŸ•µï¸â€â™‚ï¸ AIæ¨ç†ä¾¦æ¢æ¸¸æˆ V2</h2>
    <div style="color:#6b7280; font-size:16px;">æ¡ˆä»¶ç±»å‹ï¼š{{ game_state.case_type or 'æœªç”Ÿæˆ' }} | é˜¶æ®µï¼š{{ game_state.phase or 'å‡†å¤‡ä¸­' }}</div>
  </div>
  <div class="detective-main">
    <div class="detective-info">
      <h3>æ¡ˆä»¶ä¿¡æ¯</h3>
      <div><b>æ¡ˆä»¶æ¦‚è¿°ï¼š</b>{{ game_state.case_data.case_overview or 'è¯·å…ˆç”Ÿæˆæ¡ˆä»¶' }}</div>
      <div style="margin-top:10px;"><b>å—å®³è€…ï¼š</b>{{ game_state.case_data.victim.name if game_state.case_data.victim else '' }}</div>
      <div><b>æ¡ˆå‘ç°åœºï¼š</b>{{ game_state.case_data.crime_scene_description or '' }}</div>
      <div style="margin-top:10px;"><b>å«Œç–‘äººï¼š</b></div>
      <ul>
        {% for s in game_state.case_data.suspects or [] %}
        <li>{{ s.name }} - {{ s.role }} - {{ s.basic_info }}</li>
        {% endfor %}
      </ul>
      <div style="margin-top:10px;"><b>å…³é”®è¯æ®ï¼š</b></div>
      <ul>
        {% for e in game_state.case_data.key_evidence or [] %}
        <li>{{ e.name }} - {{ e.description }}</li>
        {% endfor %}
      </ul>
      <div class="detective-notebook" id="notebookBox">
        <b>æ¨ç†ç¬”è®°ï¼š</b>
        <div id="notebookContent">ï¼ˆç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯å®æ—¶è·å–æœ€æ–°ç¬”è®°ï¼‰</div>
      </div>
      <button onclick="getHint()" style="margin-top:12px;">ğŸ’¡ è·å–æç¤º</button>
    </div>
    <div class="detective-messages">
      <div class="detective-msg-list" id="msgList">
        {% for msg in messages %}
        <div class="detective-msg"><span class="role">{{ msg.role }}</span><span class="content">{{ msg.content }}</span></div>
        {% endfor %}
      </div>
      <div class="detective-actions">
        <select id="actionType" onchange="switchAction()">
          <option value="investigate">è°ƒæŸ¥ç°åœº</option>
          <option value="interrogate">å®¡è®¯å«Œç–‘äºº</option>
          <option value="analyze">åˆ†æè¯æ®</option>
          <option value="conclude">æäº¤ç»“è®º</option>
          <option value="notebook">æ¨ç†ç¬”è®°</option>
        </select>
        <input id="input1" placeholder="è¾“å…¥è°ƒæŸ¥ç›®æ ‡/å«Œç–‘äºº/è¯æ®/ç»“è®º..." style="width:180px;" />
        <input id="input2" placeholder="å¦‚æé—®å†…å®¹/æ¨ç†è¿‡ç¨‹..." style="width:180px; display:none;" />
        <button onclick="doAction()">æ‰§è¡Œ</button>
        <button onclick="refreshNotebook()">ğŸ“’ åˆ·æ–°ç¬”è®°</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
const sessionId = '{{ session_id }}';
function switchAction() {
  const type = document.getElementById('actionType').value;
  document.getElementById('input1').placeholder = type==='investigate'?'è¾“å…¥è°ƒæŸ¥ç›®æ ‡':type==='interrogate'?'è¾“å…¥å«Œç–‘äººå§“å':type==='analyze'?'è¾“å…¥è¯æ®åç§°':type==='conclude'?'è¾“å…¥å«Œç–‘äººå§“å':'è¾“å…¥å†…å®¹';
  document.getElementById('input2').style.display = (type==='interrogate'||type==='conclude')?'inline-block':'none';
  document.getElementById('input2').placeholder = type==='interrogate'?'è¾“å…¥æé—®å†…å®¹':'è¾“å…¥æ¨ç†è¿‡ç¨‹';
}
function doAction() {
  const type = document.getElementById('actionType').value;
  const v1 = document.getElementById('input1').value.trim();
  const v2 = document.getElementById('input2').value.trim();
  if(type==='investigate') return fetch('/api/game/detective-v2/start', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,case_type:v1||'murder'})}).then(r=>r.json()).then(showResult);
  if(type==='interrogate') return fetch('/api/game/detective-v2/interrogate', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,suspect_name:v1,question:v2})}).then(r=>r.json()).then(showResult);
  if(type==='analyze') return fetch('/api/game/detective-v2/analyze', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,evidence_name:v1})}).then(r=>r.json()).then(showResult);
  if(type==='conclude') return fetch('/api/game/detective-v2/conclude', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,suspect:v1,reasoning:v2})}).then(r=>r.json()).then(showResult);
  if(type==='notebook') return refreshNotebook();
}
function showResult(res) {
  if(res.success) location.reload();
  else alert(res.error||'æ“ä½œå¤±è´¥');
}
function refreshNotebook() {
  fetch(`/api/game/detective-v2/notebook?session_id=${sessionId}`).then(r=>r.json()).then(res=>{
    if(res.success) document.getElementById('notebookContent').innerText = JSON.stringify(res.notebook,null,2);
    else alert(res.error||'è·å–ç¬”è®°å¤±è´¥');
  });
}
function getHint() {
  fetch(`/api/game/detective-v2/hint?session_id=${sessionId}`).then(r=>r.json()).then(res=>{
    if(res.success) alert('æç¤ºï¼š'+res.hint);
    else alert(res.error||'è·å–æç¤ºå¤±è´¥');
  });
}
switchAction();
</script>
{% endblock %}