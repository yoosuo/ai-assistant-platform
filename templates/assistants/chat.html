{% extends "base.html" %}

{% block title %}{{ assistant_config.name }} - AIÊô∫ËÉΩÂ∑•‰ΩúÂè∞{% endblock %}

{% block extra_head %}
<!-- MarkdownÊîØÊåÅ -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">

<style>
/* ChatGPTÈ£éÊ†ºÂØπËØùÁïåÈù¢ */
.chat-layout {
    display: flex;
    height: 100vh;
    background: #f7f7f8;
}

.chat-sidebar {
    width: 280px;
    background: #202123;
    border-right: 1px solid #565869;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #565869;
}

.new-chat-btn {
    width: 100%;
    padding: 12px;
    background: #444654;
    color: white;
    border: 1px solid #565869;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
}

.new-chat-btn:hover {
    background: #565869;
}

.conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.conversation-item {
    padding: 12px;
    color: #acacbe;
    cursor: pointer;
    border-radius: 6px;
    margin-bottom: 4px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.conversation-item:hover {
    background: #343541;
}

.conversation-item.active {
    background: #343541;
    color: white;
}

.conversation-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
}

.conversation-actions {
    display: none;
    gap: 4px;
}

.conversation-item:hover .conversation-actions {
    display: flex;
}

.action-btn {
    padding: 4px;
    background: none;
    border: none;
    color: #acacbe;
    cursor: pointer;
    border-radius: 3px;
}

.action-btn:hover {
    background: #565869;
    color: white;
}

.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chat-header {
    padding: 12px 24px;
    background: white;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.assistant-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.assistant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: {{ assistant_config.theme_color or '#2E6CFB' }};
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.assistant-name {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
}

.model-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-select {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    font-size: 14px;
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    background: #f7f7f8;
}

.message {
    padding: 24px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    gap: 16px;
    max-width: none;
}

.message.user {
    background: white;
}

.message.assistant {
    background: #f7f7f8;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.user .message-avatar {
    background: #19c37d;
    color: white;
}

.assistant .message-avatar {
    background: {{ assistant_config.theme_color or '#2E6CFB' }};
    color: white;
}

.message-content {
    flex: 1;
    min-width: 0;
}

.message-text {
    line-height: 1.6;
    color: #374151;
}

.message-text pre {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 12px 0;
}

.message-text code {
    background: #f3f4f6;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 14px;
}

.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.message:hover .message-actions {
    opacity: 1;
}

.message-action-btn {
    padding: 4px 8px;
    background: none;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 12px;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
}

.message-action-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.input-container {
    padding: 24px;
    background: white;
    border-top: 1px solid #e5e5e5;
}

.input-wrapper {
    max-width: 768px;
    margin: 0 auto;
    position: relative;
}

.message-input {
    width: 100%;
    min-height: 52px;
    max-height: 200px;
    padding: 16px 48px 16px 16px;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    resize: none;
    font-size: 16px;
    line-height: 1.5;
    outline: none;
    transition: border-color 0.2s;
}

.message-input:focus {
    border-color: {{ assistant_config.theme_color or '#2E6CFB' }};
    box-shadow: 0 0 0 3px {{ assistant_config.theme_color or '#2E6CFB' }}1a;
}

.send-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    background: {{ assistant_config.theme_color or '#2E6CFB' }};
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.send-btn:hover:not(:disabled) {
    background: {{ assistant_config.theme_color or '#1d4ed8' }};
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.typing-indicator {
    padding: 24px;
    border-bottom: 1px solid #e5e5e5;
    display: none;
    background: #f7f7f8;
}

.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: 48px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #9ca3af;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
    .chat-sidebar {
        position: fixed;
        left: -280px;
        z-index: 1000;
        transition: left 0.3s;
    }
    
    .chat-sidebar.open {
        left: 0;
    }
    
    .chat-main {
        width: 100%;
    }
    
    .message {
        padding: 16px;
    }
    
    .input-container {
        padding: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- ‰æßËæπÊ†è -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">
                <i class="fas fa-plus"></i> Êñ∞ÂØπËØù
            </button>
        </div>
        
        <div class="conversations-list" id="conversationsList">
            {% for conv in conversations %}
            <div class="conversation-item {% if conv.id == session_id %}active{% endif %}" 
                 onclick="switchConversation('{{ conv.id }}', '{{ conv.assistant_type }}')">
                <span class="conversation-title" title="{{ conv.title }}">{{ conv.title }}</span>
                <div class="conversation-actions">
                    <button class="action-btn" onclick="renameConversation('{{ conv.id }}', event)" title="ÈáçÂëΩÂêç">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn" onclick="deleteConversation('{{ conv.id }}', event)" title="Âà†Èô§">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- ‰∏ªÂØπËØùÂå∫Âüü -->
    <div class="chat-main">
        <!-- Â§¥ÈÉ® -->
        <div class="chat-header">
            <div class="assistant-info">
                <button class="action-btn d-md-none" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="assistant-avatar">{{ assistant_config.icon }}</div>
                <div>
                    <div class="assistant-name">{{ assistant_config.name }}</div>
                    <div style="font-size: 12px; color: #6b7280;">Âú®Á∫ø</div>
                </div>
            </div>
            
            <div class="model-selector">
                <label for="modelSelect" style="font-size: 14px; color: #6b7280;">Ê®°Âûã:</label>
                <select id="modelSelect" class="model-select" onchange="switchModel(this.value)">
                    <optgroup label="üèÜ ÈòøÈáå‰∫ëÁôæÁÇº (Êé®Ëçê)">
                        <option value="qwen-plus" selected>Qwen Plus (Êé®Ëçê)</option>
                        <option value="qwen-max">Qwen Max (ÊúÄÂº∫)</option>
                        <option value="qwen-turbo">Qwen Turbo (Âø´ÈÄü)</option>
                        <option value="qwen3-32b">Qwen3 32B (ÂºÄÊ∫ê)</option>
                        <option value="qwen3-14b">Qwen3 14B (ÂºÄÊ∫ê)</option>
                    </optgroup>
                    <optgroup label="üÜì OpenRouter ÂÖçË¥πÊ®°Âûã">
                        <option value="qwen3-14b-free">Qwen3 14B (ÂÖçË¥π)</option>
                        <option value="qwen3-4b-free">Qwen3 4B (ÂÖçË¥π)</option>
                        <option value="llama-3.2-3b-free">Llama 3.2 3B (ÂÖçË¥π)</option>
                        <option value="mistral-7b-free">Mistral 7B (ÂÖçË¥π)</option>
                        <option value="phi-3-mini-free">Phi-3 Mini (ÂÖçË¥π)</option>
                    </optgroup>
                    <optgroup label="üíé OpenRouter È´òÁ∫ßÊ®°Âûã">
                        <option value="gemini-flash">Gemini Flash</option>
                        <option value="gemini-pro">Gemini Pro</option>
                        <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                    </optgroup>
                </select>
            </div>
        </div>
        
        <!-- Ê∂àÊÅØÂå∫Âüü -->
        <div class="messages-container" id="messagesContainer">
            {% for msg in history %}
            <div class="message {{ msg.role }}">
                <div class="message-avatar">
                    {% if msg.role == 'user' %}
                        üë§
                    {% else %}
                        {{ assistant_config.icon }}
                    {% endif %}
                </div>
                <div class="message-content">
                    <div class="message-text">{{ msg.content | safe }}</div>
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="copyMessage(this)">
                            <i class="fas fa-copy"></i> Â§çÂà∂
                        </button>
                        {% if msg.role == 'assistant' %}
                        <button class="message-action-btn" onclick="regenerateMessage('{{ msg.id }}')">
                            <i class="fas fa-redo"></i> ÈáçÊñ∞ÁîüÊàê
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- ÊâìÂ≠óÊåáÁ§∫Âô® -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="message assistant">
                    <div class="message-avatar">{{ assistant_config.icon }}</div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ËæìÂÖ•Âå∫Âüü -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea id="messageInput" class="message-input" 
                         placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ... (Shift+Enter Êç¢Ë°å)"
                         rows="1"></textarea>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ÂÖ®Â±ÄÂèòÈáè
let sessionId = '{{ session_id }}';
let assistantType = '{{ assistant_type }}';
let isStreaming = false;

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    setupMessageInput();
    scrollToBottom();
    
    // Ê†áËÆ∞Markdown
    document.querySelectorAll('.message-text').forEach(el => {
        if (el.innerHTML.includes('```') || el.innerHTML.includes('`')) {
            el.innerHTML = marked.parse(el.innerHTML);
            el.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
        }
    });
});

// ËÆæÁΩÆÊ∂àÊÅØËæìÂÖ•Ê°Ü
function setupMessageInput() {
    const input = document.getElementById('messageInput');
    
    // Ëá™Âä®Ë∞ÉÊï¥È´òÂ∫¶
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    // ÈîÆÁõòÂø´Êç∑ÈîÆ
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// ÂèëÈÄÅÊ∂àÊÅØ
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || isStreaming) return;
    
    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    input.value = '';
    input.style.height = 'auto';
    
    // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
    addMessageToUI('user', message);
    
    // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
    showTypingIndicator();
    
    // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆ
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    isStreaming = true;
    
    try {
        const response = await fetch('/api/assistant/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                message: message,
                stream: false
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Ê∑ªÂä†AIÂõûÂ§çÂà∞ÁïåÈù¢
            addMessageToUI('assistant', result.content);
        } else {
            addMessageToUI('assistant', 'Êä±Ê≠âÔºåÂèëÁîü‰∫ÜÈîôËØØÔºö' + result.error);
        }
    } catch (error) {
        addMessageToUI('assistant', 'Êä±Ê≠âÔºåÁΩëÁªúËøûÊé•Âá∫Áé∞ÈóÆÈ¢òÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
    } finally {
        hideTypingIndicator();
        sendBtn.disabled = false;
        isStreaming = false;
        input.focus();
    }
}

// Ê∑ªÂä†Ê∂àÊÅØÂà∞ÁïåÈù¢
function addMessageToUI(role, content) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const avatar = role === 'user' ? 'üë§' : '{{ assistant_config.icon }}';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            <div class="message-text">${marked.parse(content)}</div>
            <div class="message-actions">
                <button class="message-action-btn" onclick="copyMessage(this)">
                    <i class="fas fa-copy"></i> Â§çÂà∂
                </button>
                ${role === 'assistant' ? `
                <button class="message-action-btn" onclick="regenerateMessage()">
                    <i class="fas fa-redo"></i> ÈáçÊñ∞ÁîüÊàê
                </button>
                ` : ''}
            </div>
        </div>
    `;
    
    // Âú®ÊâìÂ≠óÊåáÁ§∫Âô®‰πãÂâçÊèíÂÖ•
    const typingIndicator = document.getElementById('typingIndicator');
    container.insertBefore(messageDiv, typingIndicator);
    
    // È´ò‰∫Æ‰ª£Á†Å
    messageDiv.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
    });
    
    scrollToBottom();
}

// ÊòæÁ§∫/ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
    scrollToBottom();
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

// ÊªöÂä®Âà∞Â∫ïÈÉ®
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
}

// ÂàõÂª∫Êñ∞ÂØπËØù
function createNewChat() {
    fetch('/api/conversation/new', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            assistant_type: assistantType
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.href = result.redirect_url;
        }
    });
}

// ÂàáÊç¢ÂØπËØù
function switchConversation(convId, convAssistantType) {
    window.location.href = `/assistant/${convAssistantType}?session_id=${convId}`;
}

// ÈáçÂëΩÂêçÂØπËØù
function renameConversation(convId, event) {
    event.stopPropagation();
    
    const newTitle = prompt('ËØ∑ËæìÂÖ•Êñ∞Ê†áÈ¢òÔºö');
    if (newTitle && newTitle.trim()) {
        fetch(`/api/conversation/${convId}/rename`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: newTitle.trim()
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('ÈáçÂëΩÂêçÂ§±Ë¥•Ôºö' + result.error);
            }
        });
    }
}

// Âà†Èô§ÂØπËØù
function deleteConversation(convId, event) {
    event.stopPropagation();
    
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        fetch(`/api/conversation/${convId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (convId === sessionId) {
                    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåÂàõÂª∫Êñ∞ÂØπËØù
                    createNewChat();
                } else {
                    location.reload();
                }
            } else {
                alert('Âà†Èô§Â§±Ë¥•Ôºö' + result.error);
            }
        });
    }
}

// ÂàáÊç¢Ê®°Âûã
function switchModel(model) {
    fetch('/api/model/switch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            model: model
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // ÂèØ‰ª•ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            console.log('Ê®°ÂûãÂàáÊç¢ÊàêÂäüÔºö' + model);
        } else {
            alert('Ê®°ÂûãÂàáÊç¢Â§±Ë¥•Ôºö' + result.error);
        }
    });
}

// Â§çÂà∂Ê∂àÊÅØ
function copyMessage(btn) {
    const messageText = btn.closest('.message-content').querySelector('.message-text');
    const text = messageText.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> Â∑≤Â§çÂà∂';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-copy"></i> Â§çÂà∂';
        }, 2000);
    });
}

// ÈáçÊñ∞ÁîüÊàêÊ∂àÊÅØ
function regenerateMessage() {
    // TODO: ÂÆûÁé∞ÈáçÊñ∞ÁîüÊàêÂäüËÉΩ
    alert('ÈáçÊñ∞ÁîüÊàêÂäüËÉΩÂºÄÂèë‰∏≠...');
}

// ÂàáÊç¢‰æßËæπÊ†è
function toggleSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    sidebar.classList.toggle('open');
}
</script>
{% endblock %}